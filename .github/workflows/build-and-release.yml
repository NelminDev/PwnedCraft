name: Build & Release

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g. 1.0.0)'
        required: true
        type: string

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: 8.13

      - name: Generate Gradle Wrapper
        run: gradle wrapper --gradle-version 8.13 --distribution-type bin

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Extract version and check description file
        id: release_info
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
            VERSION="${{ inputs.version }}"
          elif [[ "${{ github.event.head_commit.message }}" =~ release\((.*?)\) ]]; then
            echo "version=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            VERSION="${BASH_REMATCH[1]}"
          else
            echo "is_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ -f "descriptions/${VERSION}.txt" ]; then
            echo "is_release=true" >> $GITHUB_OUTPUT
          else
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "::error::Release description file descriptions/${VERSION}.txt not found"
            exit 1
          fi

      - name: Build with Gradle
        run: ./gradlew clean shadowJar

      - name: Read Release Description
        if: steps.release_info.outputs.is_release == 'true'
        id: release_description
        run: |
          DESCRIPTION=$(cat "descriptions/${{ steps.release_info.outputs.version }}.txt")
          DESCRIPTION="${DESCRIPTION//'%'/'%25'}"
          DESCRIPTION="${DESCRIPTION//$'\n'/'%0A'}"
          DESCRIPTION="${DESCRIPTION//$'\r'/'%0D'}"
          echo "content=$DESCRIPTION" >> $GITHUB_OUTPUT

      - name: Create Release
        if: steps.release_info.outputs.is_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.release_info.outputs.version }}
          name: Release v${{ steps.release_info.outputs.version }}
          body: |
            ## ⚠️ CRITICAL SECURITY DISCLAIMER ⚠️

            **WARNING: This plugin contains potentially harmful functionality and should NEVER be used on production servers!**

            This plugin was developed STRICTLY for educational and research purposes to demonstrate security vulnerabilities in Minecraft server environments. It contains features that can:
            - Execute system commands on the host machine
            - Modify server files and configurations
            - Impersonate other players
            - Grant unauthorized access to server controls
            - Potentially compromise server security

            DO NOT:
            - Install this plugin on any production server
            - Use this in a public server environment
            - Install plugins from untrusted sources
            - Run this plugin without understanding its full capabilities

            SECURITY CHECKLIST:
            - Always verify the source of plugins before installation
            - Carefully review plugin permissions and features
            - Scan suspicious plugins for malicious code
            - Never install plugins sent by unknown users
            - Be extremely cautious of plugins with system command access

            By using this plugin, you acknowledge that it is meant for EDUCATIONAL PURPOSES ONLY and that any misuse or deployment in unauthorized environments is strictly prohibited and could result in severe security breaches.

            ${{ steps.release_description.outputs.content }}
          files: build/libs/PwnedCraft.jar
          draft: false
          prerelease: false